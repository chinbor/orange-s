## orange's 第四章学习笔记

### 一. 突破512字节的限制

> #### 一个操作系统从开机到开始运行，大致经历“引导-&gt;加载内核入内存-&gt;跳入保护模式-&gt;开始执行内核”,在内核开始执行之前不但要加载内核，而且还有准备保护模式等一系列工作，由于这一系列工作有点大，引导扇区的512字节可能不够用，所以可以将这个过程交给一个loader模块来做，引导程序就只需要将loader加载如内存，然后控制权给它，其他工作就由loader来做

### 二. FAT12

> #### FAT12是DOS时代就开始使用的文件系统\(File System\)，直到现在仍然在软盘上使用，FAT12软盘被格式化后为：有两个磁头，每个磁头80个柱面（磁道），每个柱面有18个扇区，每个扇区512个字节空间。所以标准软盘的总空间为
>
> #### 2 \* 80 \*18 \* 512=1474560B=1440K=1.44m
>
> #### 下面是FAT12的结构图：
>
> ![](http://hi.csdn.net/attachment/201202/22/0_1329914901XICx.gif)
>
> #### 1、引导扇区
>
> #### 操作系统之所以认识FAT12格式的磁盘，其秘密就在于逻辑0扇区这512B上。如果这512字节的最后两个字节的内容分别是55和AA（0xAA55低字节在前，高字节在后\)的话，BIOS在启动时会将这个扇区读取到0:7C00h-0:7DFFh处，然后跳转到0:7C00h处继续执行指令，操作系统即用此来达到引导系统的目的，而这个磁盘就称为引导磁盘。
>
> #### 操作系统标识FAT12文件系统是因为在逻辑0扇区\(即引导扇区\)处还存储着一个特定的数据结构，此结构有固定的格式，在操作系统将此磁盘格式化时自动生成，具体数据结构如下表所示：
>
> ![](/assets/QQ图片20190503190103.png)下面我们介绍其中的一些变量的含义：
>
> BS\_jmpBoot：是跳转指令，偏移0处的跳转指令必须是合法的可执行的基于x86的CPU指令，如：jmp start，这样可以生成3字节长的指令，（加关键字short的短跳转指令的长度是2字节），指向操作系统引导代码部分。Windows和MS-DOS生成的FAT12启动扇区中的跳转指令是短跳转，如：jmp short LABEL\_START，然后加一个nop的空指令来保持3字节的长度。
>
> BPB\_BytsPerSec：每扇区的字节数，类型是双字节长，标准分区上的每扇区字节数一般是512B， FAT12的格式下设置为512\(0x200h\)。
>
> BPB\_SecPerClus：每簇扇区数，偏移13处，类型是字节，簇是数据存储的最小单位，在FAT12格式下一般为1，即每簇只有1个扇区\(512字节\)。
>
> BPB\_RsvdSecCnt：Boot记录占用多少扇区，即在FAT1之前的 引导扇区，一般情况下，引导扇区占用1个扇区。
>
> BPB\_NumFATs：共有多少个FAT表，默认情况下此字段的值为2，也就是有两个FAT表，FAT1和FAT2的内容相同，当FAT1表出错的时候可以使用FAT2来恢复文件分配表。
>
> BPB\_RootEntCnt：根目录文件数最大值，默认为224，每个目录条目占用32B的空间，因此根目录的大小为：224\*32/512=14，即占用14个扇区。
>
> BPB\_TotSec16：扇区总数=0xB40=2880
>
> BPB\_FATSz16：每个FAT占用的扇区数=0x9=9，即FAT1占用1—9逻辑扇区，FAT2占用10—18逻辑扇区。
>
> BPB\_SecPerTrk：每磁道扇区数=0x12=18，即标准FAT12文件系统中，每个磁道的扇区数就是为18。
>
> BPB\_NumHeads：磁头数=0x2=2，该磁盘包括2个磁头，也就是面数是2。
>
> #### 2、FAT表
>
> FAT1和FAT2是两个完全相同的FAT表，每个FAT占用9个扇区。其中FAT1占用1—9扇区，FAT2占用10—18扇区。具体详细介绍看下面4。
>
> #### 3、根目录区
>
> 根目录区的开始扇区号是19，它是由若干个目录条目\(Directory Entry\)组成，条目最多有BPB\_RootEntCnt个，由于根目录区的大小是依赖于BPB\_RootEntCnt的，所以长度不固定。
>
> 在本FAT12中，因为BPB\_RootEntCnt=0xE0=14\*16+0=244，即条目最多为244个，又因为每个条目占用32个字节，故244\*32/512=14，即该根目录区占14个扇区，即19—32。
>
> 根目录区中的每个条目占用32字节，它的格式如下图：
>
> ![](http://hi.csdn.net/attachment/201202/22/0_1329915281Cclw.gif)
>
> 在这里需要注意的是，数据区的第一个簇的簇号是2，而不是0或者1







