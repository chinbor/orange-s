# First Chapter

## 一.**保护模式简介**

#### 在保护方式下,全部32条地址线有效,可寻址高达4G字节的物理地址空间;**扩充的存储器分段管理机制和可选的存储器分页管理机制**,不仅为存储器共享和保护提供了硬件支持,而且为实现虚拟存储器提供了硬件支持;支持多任务,能够快速地进行任务切换和保护任务环境;4个特权级和完善的特权检查机制,既能实现资源共享又能保证代码和数据的安全和保密及任务的隔离;支持虚拟8086方式,便于执行8086程序。

## 二.存储管理机制

#### 保护方式下，80386不仅采用扩充的存储器分段管理机制，而且提供可选的存储器分页管理机制，这些存储管理机制由80386存储管理部件MMU实现。

#### 1.目标

#### 在以80386及其以上处理器为CPU的PC兼容机系统中,把地址在1M以下的内存称为常规内存,把地址在1M以上的内存称为扩展内存。

#### 80386 还要对实现虚拟存储器提供支持。虽然与 8086 可寻址的1M字节物理地址空间相比,80386可寻址的物理地址空间可谓很大,但实际的微机系统不可能安装如此达的物理内存。所以,为了运行大型程序和真正实现多任务,必须采用虚拟存储器。

#### 所以,80386既要支持任务隔离,又要支持可共享代码和数据的共享,还要支持特权保护。

#### 2.地址空间和地址转换

#### 保护方式下的虚拟存储器由大小可变的存储块构成,这样的存储块称为段。虚拟存储器的地址\(逻辑地址\)由指示描述符的选择子和段内偏移两部分构成,这样的地址集合称为虚拟地址空间。80386支持的虚拟地址空间可达64T字节。程序员编写程序时使用的存储地址空间是虚拟地址空间,所以,他们可认为有足够大的存储空间可供使用。

#### 虚拟地址空间必须映射到物理地址空间,二维的虚拟地址必须转化成一维的物理地址。每一个任务有一个虚拟地址空间，为了避免多个并行任务的多个虚拟地址空间直接映射到同一个物理地址空间,采用线性地址空间隔离虚拟地址空间和物理地址空间。线性地址空间由一维的线性地址构成,线性地址空间和物理地址空间对等。线性地址32位长,线性地址空间容量为4G字节。

#### 80386 分两步实现虚拟地址空间到物理地址空间到物理地址空间的映射,也就是分两步实现虚拟地址到物理地址的转换,但第二步是可选的。下图是地址映射转换的示意图

#### ![](https://img-blog.csdn.net/20150312173704225)

#### 通过描述符表（gdt）和描述符,分段管理机制实现虚拟地址空间到线性地址空间的映射,实现把二维的虚拟地址转换为一维的线性地址。这一步总是存在的。分页管理机制把线性地址空间和物理地址空间分别划分为大小相同的块,这样的块称为页。通过在线性地址空间的页与物理地址空间的页建立之间的映射表,分页管理机制实现线性地址空间到物理地址空间的映射,实现线性地址到物理地址的转换。分页管理机制是可选的,在不采用分页管理机制时,线性地址空间就等同于物理地址空间,线性地址就等于物理地址。

## 三.保护机制

#### 1.不同任务之间的保护

#### 任务A的虚拟地址空间映射到物理地址空间的某个区域,而任务B的虚拟地址空间映射到物理地址空间的另外区域,彼此独立,互不相干。因此,两个不同的任务,尽管虚拟存储单元地址相同,但实际的物理存储单元地址可以不同。

#### 2.同一任务之间的保护

#### 在一个任务之内,定义有四种执行特权级别,用于限制对任务中的段进行访问。

![](https://img-blog.csdn.net/20150312174131094)

#### 在任何时候,一个任务总是在四个特权级之一下运行,任务在特定时刻的特权级称为当前特权级\(Current Privilege level\),标记为CPL,即当前运行程序的特权级。每当一个程序试图访问一个段时,就把CPL与要访问的段的特权级进行比较,以决定是否允许这一访问。对给定CPL执行的程序,允许访问同一级别或外层级别的数据段。如上图所示,CodeK可访问同级的数据段DataK,也可访问外层的DataOS、DataAP1及DataAP2等。如果试图访问内层级别的数据段则是非法的,并引起异常。如上图所示,CodeOS可访问同级的DataOS,也可访问外层的DataAP1和DataAP2等,但不能访问内层的DataK。

#### 虽然应用程序都在最外层,但由于各个不同的应用程序存储在不同的虚拟地址空间中,所以各应用程序被隔离保护。如上图所示,最外层的CodeAP1只能访问DataAP1,不可能访问同级的另一应用程序的DataAP2;同样,CodeAP2只能访问DataAP2,不可能访问DataAP1。

#### 特权级的典型用法是,把操作系统的核心部分放在0级,操作系统的其余部分放在 1级,而应用程序放在3 级,留下的2级供中间软件使用。对特权级进行这样的安排,使得在0级的操作系统核心有权访问任务中的所有存储段;而在3级的应用程序只能访问程序本身的存储段,这些存储段也是在3级\(注意,Windows 9X 操作系统只使用了 0 级和3级,以便于移植到精简指令集的计算机上,如RS4000等,这些处理器一般只有两个特权级,即系统级和用户级\)。

## 四.分段管理机制

#### 有了分段机制，实模式与保护模式下的寻址也有所不同:

#### 在实模式下，也就是在8086系统下的寻址方式。 Intel 8086是16位的CPU，它有着16位的寄存器\(Register\)，16位的数据总线\(Data Bus\)以及20位的地址总线\(Address Bus\)和1MB的寻址能力。一个地址是由段和偏移两部分组成的，物理地址遵循这样的计算公式：

#### 物理地址\(Physical Address\) = 段值\(Segment\) \* 16 + 偏移\(Offset\)。其中段值和偏移都是16位的。故寻址范围为1MB。

#### 在保护模式下，首先使用段选择子在段描述符表中查找到相对应的段描述符，找到32位段基址，然后在与32位的偏移量相加，得到线性地址。段基址和段偏移量都是32位的，所以寻址范围大小为4GB

![](https://img-blog.csdn.net/20150312203106009)

#### 1.段定义和虚拟地址到线性地址的转换

#### 在保护方式下,每个段由如下三个参数进行定义:段基地址\(Base Address\)、段界限\(Limit\)和段属性\(Attributes\)。

#### 段基地址规定线性地址空间中段的开始地址。在80386保护方式下,段基地址长 32位。因为基地址长度与寻址地址的长度相同,所以任何一个段都可以从32位线性地址空间中的任何一个字节开始,而不象实方式下规定的边界必须被16整除。

#### 段界限规定段的大小。在 80386保护模式下,段界限用20 位表示,而且段界限可以是以字节为单位或以4K字节为单位。段属性中有一位对此进行定义,把该位称为粒度位,用符号G标记。G=0表示段界限以字节为单位,于是20 位的界限可表示的范围是1字节至 1M字节,增量为1字节;G=1表示段界限以4K字节为单位,于是20位的界限可表示的范围是4K 字节至4G字节,增量为 4K字节。

#### 当段界限以4K字节为单位时,实际的段界限LIMIT 可通过下面的公式从 20位段界限Limit计算出来:

> #### LIMIT=limit\*4K+0FFFH=\(Limit SHL 12\)+0FFFH

#### 所以当粒度为 1时,段的界限实际上就扩展成32 位。由此可见,在80386保护模式下,段的长度可大大超过 64K字节。基地址和界限定义了段所映射的线性地址的范围。基地址Base是线性地址对应于段内偏移为 0的虚拟地址,段内偏移为X 的虚拟

#### 地址对应 Base+X的线性地址。段内从偏移0 到Limit范围内的虚拟地址对应于从 Base到Base+Limit范围内的线性地址。下图表示一个段如何从虚拟地址空间定位到线性地址空间。图中BaseA等代表段基地址, LimitA等代表段界限。另外,段C 接在段 A之后,也即BaseC=BaseA+LimitA。

![](https://img-blog.csdn.net/20150312174412211)

#### 通过增加段界限,可以使段的容量得到扩展

#### 

本文内容转自csdn博客，原文地址
 [https://blog.csdn.net/u014634338/article/details/44225841](https://blog.csdn.net/u014634338/article/details/44223851)
 
 
 [ next > ](chapter2.md)



