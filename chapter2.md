# Second Chapter

## 一.存储段描述符

#### 用于表示上述定义段的三个参数的数据结构称为描述符。每个描述符长8个字节。在保护方式下,每一个段都有一个相应的描述符来描述。

#### 1.存储段描述符的格式

#### 存储段是存放可由程序直接进行访问的代码和数据的段。存储段描述符描述存储段,所以存储段描述符也被称为代码和数据段描述符。存储段描述符的格式如下表所示。表中上面一排是对描述符8个字节的使用的说明,最低地址字节\(假设地址为m\)在最右边,其余字节依次向左,直到最高字节\(地址为m+7\)。下一排是对属性域各位的说明。

#### ![](https://img-blog.csdn.net/20150312192201306)![](https://img-blog.csdn.net/20150312192342217)从上表可知,长 32 位的段基地址\(段开始地址\)被安排在描述符的两个域中,其位 0—位 23 安排在描述符内的第 2—第 4 字节中,其位 24—位 31 被安排在描述符内的第 7 字节中。长 20 位的段界限也被安排在描述符的两个域中,其位 0—位 15 被安排在描述符内的第 0—第 1 字节中,其位 16—位 19 被安排在描述符内的第 6 字节的低 4 位中。

#### 80386 描述符中的段属性也被安排在两个域中。下面对其定义及意义作说明。

* #### P 位称为存在\(Present\)位。P=1 表示描述符对地址转换是有效的,或者说该描述符所描述的段存在,即在内存中;P=0 表示描述符对地址转换无效,即该段不存在。使用该描述符进行内存访问时会引起异常。
* #### DPL 表示描述符特权级\(Descriptor Privilege level\),共 2 位。它规定了所描述段的特权级,用于特权检查,以决定对该段能否访问。
* #### DT 位说明描述符的类型。对于存储段描述符而言,DT=1,以区别与系统段描述符和门描述符\(DT=0\)。
* #### TYPE 说明存储段描述符所描述的存储段的具体属性。其中的位 0 指示描述符是否被访问过\(Accessed\),用符号 A 标记。A=0 表示尚未被访问,A=1 表示段已被访问。当把描述符的相应选择子装入到段寄存器时,80386 把该位置为 1,表明描述符已被访问。操作系统可测试访问位,已确定描述符是否被访问过。其中的位 3 指示所描述的段是代码段还是数据段,用符号 E 标记。E=0 表示段为数据段,相应的描述符也就是数据段\(包括堆栈段\)描述符。数据段是不可执行的,但总是可读的。 E=1 表示段是可执行段,即代码段,相应的描述符就是代码段描述符。代码段总是不可写的,若需要对代码段进行写入操作,则必须使用别名技术,即用一个可写的数据段描述符来描述该代码段,然后对此数据段进行写入。在数据段描述符中\(E=0 的情况\),TYPE 中的位 1 指示所描述的数据段是否可写,用 W 标记。 W=0 表示对应的数据段不可写。反之,W=1 表示数据段是可写的。注意,数据段总是可读的。TYPE 中的位 2 是 ED 位,指示所描述的数据段的扩展方向。ED=0 表示数据段向高端扩展,也即段内偏移必须小于等于段界限。ED=1 表示数据段向低扩展,段内偏移必须大于段界限。

  #### 在代码段描述符中\(E=1 的情况\),TYPE 中的位 1 指示所描述的代码段是否可读,用符号 R 标记。R=0 表示对应的代码段不可读,只能执行。R=1 表示对应的代码段可读可执行。注意代码段总是不可写的,若需要对代码段进行写入操作,则必须使用别名技术。在代码段中,TYPE 中的位 2 指示所描述的代码段是否是一致代码段,用 C 标记。C=0 表示对应的代码段不是一致代码段\(普通代码段\),C=1表示对应的代码段是一致代码段。
* #### G 位就是段界限粒度\(Granularity\)位。G=0 表示界限粒度为字节;G=1 表示界限粒度为 4K 字节。注意,界限粒度只对段界限有效,对段基地址无效,段基地址总是以字节为单位。
* #### D 位是一个很特殊的位,在描述可执行段、向下扩展数据段或由 SS 寄存器寻址的段\(通常是堆栈段\)的三种描述符中的意义各不相同。

  #### 在描述可执行段的描述符中,D 位决定了指令使用的地址及操作数所默认的大小。D=1 表示默认情况下指令使用 32 位地址及 32 位或 8 位操作数,这样的代码段也称为 32 位代码段;D=0 表示默认情况下,使用 16 位地址及 16 位或 8 位操作数,这样的代码段也称为16 位代码段,它与 80286 兼容。可以使用地址大小前缀和操作数大小前缀分别改变默认的地址或操作数的大小。

  #### 在向下扩展数据段的描述符中,D 位决定段的上部边界。D=1 表示段的上部界限为 4G;D=0 表示段的上部界限为 64K,这是为了与 80286 兼容。

  #### 在描述由 SS 寄存器寻址的段描述符中,D 位决定隐式的堆栈访问指令\(如 PUSH 和 POP 指令\)使用何种堆栈指针寄存器。D=1 表示使用 32 位堆栈指针寄存器 ESP;D=0 表示使用 16 位堆栈指针寄存器 SP,这与 80286 兼容。
* #### AVL 位是软件可利用位。80386 对该位的使用未做规定,Intel 公司也保证今后开发生产的处理器只要与 80386 兼容,就不会对该位的使用做任何定义或规定。此外,描述符内第 6 字节中的位 5 必须置为 0,可以理解成是为以后的处理器保留的。 

#### 



