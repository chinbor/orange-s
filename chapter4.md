# Fourth Chapter

### 一.**不同特权级数据段之间的访问规则**

#### 数据段中DPL规定了可以访问此段的最低特权级，因此，对数据的访问，只要CPL和RPL都小于被访问的数据段的DPL就可以了，即CPL&lt;=DPL和RPL&lt;=DPL。

### 二.不同特权级代码段之间的转移

#### 程序从一个代码段转移到另一个代码段之前，目标代码段的选择子会被加载到cs中，处理器将会监查描述符的界限，类型，特权及等内容，当前代码段有cpl，而目标代码段选择子有rpl，并且描述符中还有dpl

#### 使用jmp和call指令可以实现下列4种转移（也就两大类，一种是直接，一种是间接）：

> 1.目标操作数包含目标代码的段选择子   jmp  selectorvideo：0
>
> 2.目标操作数指向一个包含目标代码段选择子的调用门描述符
>
> 3.目标操作数指向一个包含目标代码段选择子的tss
>
> 4.目标操作数指向一个任务门，这个任务门指向一个包含目标代码段选择子的tss

#### 通过jmp和call指令进行代码段之间转移有限，对于非一致代码段只能在相同特权级代码段之间转移（cpl=dpl，rpl&lt;=dpl）对于一致代码段只能从低到高访问（cpl&gt;=dpl并且rpl不检验并且cpl延续下去，到了目标代码段仍然是之前的cpl），所以想要自由的进行不同特权级的转移需要用到门描述符或tss.

![](https://img-blog.csdn.net/20150331132418652)

### 三.任务状态段tss

#### 每个任务有一个任务状态段 TSS,用于保存任务的有关信息,在任务内变换特权级和任务切换时,要用到这些信息。为了控制任务内发生特权级变换的转移,为了控制任务切换,一般要通过控制门进行这些转移

#### 1.系统段描述符

> 系统段是为了实现存储管理机制所使用的一种特别的段。在 80386 中,有两种系统段:任务状态段 TSS 和局部描述符表 LDT 段。用于描述系统段的描述符称为系统段描述符。

#### 系统段描述符的一般格式如下表所示

#### ![](https://img-blog.csdn.net/20150401165615813)![](https://img-blog.csdn.net/20150401165558515)与存储段描述符相比,它们很相似,区分的标志是属性字节中的描述符类型位 DT 的值。DT=1 表示存储段（数据和代码段）,DT=0 表示系统段。系统段描述符中的段基地址和段界限字段与存储段描述符中的意义完全相同;属性中的 G 位、AVL 位、P 位和 DPL 字段的作用也完全相同。存储段描述符属性中的 D 位在系统段描述符中不使用,现用符号 X 表示。系统段描述符的类型字段 TYPE 仍是 4 位,其编码及表示的类型列于下表,其含义与存储段描述符的类型却完全不同。 ![](https://img-blog.csdn.net/20150401165733348)需要注意的是,系统段描述符的选择子不能用来读写系统段,要想读写系统段,必须使用别名技术。

> LDT 段描述符描述任务的局部描述符表段。LDT 段描述符必须安排在全局描述符表中才有效。在装载 LDTR 寄存器时,描述符中的 LDT 段基地址和段界限等信息被装入 LDT段描述符高速缓冲寄存器中。

> 任务状态段 TSS 用于保存任务的各种状态信息。TSS 描述符分为 286TSS 和 386TSS 两类TSS 描述符规定了任务状态段的基地址和任务状态段的大小等信息。在装载任务状态段寄存器 TR 时,描述符中的段基地址和段界限等信息被装入到 TR 的高速缓冲寄存器中。在任务切换或执行 LTR指令时,要装载 TR 寄存器
>
> TSS 描述符中的类型规定:TSS 要么为“忙”,要么为“可用”。如果一个任务是当前正执行的任务,或者是用 TSS 中的链接字段沿挂起任务链接到当前任务上的任务,那么该任务是“忙”的任务;否则该任务为“可用”任务。
>
> 利用段间转移指令 JMP 和段间调用指令 CALL,直接通过 TSS 描述符或通过任务门可实现任务切换**（在同一任务内,实现特权级从外层到内层变换的普通途径是使用段间调用指令 CALL,通过调用门进行转移;实现特权级从内层向外层变换的普通途径是使用段间返回指令 RET。注意,不能用 JMP 指令实现任务内不同特权级的变换。 ）**

#### 四.门描述符

#### 除存储段描述符（代码数据段）和系统段描述符（tss和ldt）外,还有一类门描述符。门描述符并不描述某种内存段,而是描述控制转移的入口点。这种描述符好比一个通向另一代码段的门。通过这种门,可实现任务内（一个任务可以由很多不同段组成）特权级的变换和任务间的切换。所以,这种门描述符也称为控制门。

#### 1.门描述符的一般格式

![](https://img-blog.csdn.net/20150402210238277)

#### 8个字节，定义了目标代码对应段的选择子，入口地址的偏移，一些属性，注意这里的BYTE5和其他描述符都是一样的这里的s位将为0 

#### 可定义如下的门描述符结构类型

```
;windows 平台下汇编格式
GATE STRUC          ;门结构类型定义
    OFFSETL DW      ;32 位偏移的低16 位
    SELECTOR DW     ;选择子
    DCOUNT DB       ;双字计数字段
    GTYPE DB 0      ;类型
    OFFSETH DW 0    ;32 位偏移的高16 位
GATE ENDS
```

#### 从上述描述符类型的列表中可见,门描述符又可分为:任务门、调用门、中断门和陷阱门,并且除任务门外,其它描述符还各分成286 和 386 两种。 



